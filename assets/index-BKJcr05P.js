function t(t){const e=10*Math.random()+5,n=16777215*Math.random()+0,i=.2*e/4,a=.05*e/4,o=.8*e/4,s=.4*e/4,r=Math.random()*Math.PI*2,c=Math.random()*Math.PI,l=Math.sin(c)*Math.cos(r)*t,d=Math.cos(c)*t,h=Math.sin(c)*Math.sin(r)*t,m=new THREE.Vector3(l,d,h),u=new THREE.Group,g=new THREE.CylinderGeometry(a,a,i,8),p=new THREE.MeshPhongMaterial({color:n}),v=new THREE.Mesh(g,p);v.position.y+=i/2,v.castShadow=!0,v.receiveShadow=!0;const y=new THREE.ConeGeometry(s,o,8),f=new THREE.MeshPhongMaterial({color:n}),E=new THREE.Mesh(y,f);E.position.y+=i+o/2,E.castShadow=!0,E.receiveShadow=!0,u.add(v),u.add(E),u.position.copy(m);const w=m.clone().normalize(),S=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,1,0),w);return u.quaternion.copy(S),u}function e(t,e){const n=new THREE.Vector3(t.x,t.y,t.z).clone().normalize().clone().multiplyScalar(e);return{x:n.x,y:n.y,z:n.z}}function n(t,n){const i=[];return t.points.forEach((t,a)=>{const o=function(t,n,i){const a=new THREE.Group,o=new THREE.CylinderGeometry(1,1,.01,64),s=new THREE.TorusGeometry(1,.06,32,32),r=new THREE.ShaderMaterial({uniforms:{time:{value:0},useRainbowColors:{value:0===n}},vertexShader:"\n\t\tvarying vec2 vUv;\n\t\tvoid main() {\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n\t\t}\n\t",fragmentShader:"\n\tuniform vec2 resolution;\n    uniform float time;\n    varying vec2 vUv;\n    uniform bool useRainbowColors; // New boolean uniform\n\n    float random(float seed) {\n        return fract(sin(seed) * 43758.5453);\n    }\n\n    void main() {\n\t\tvec2 uv = vUv;\n\n\t\t// Calculate the distance from the center of the UV coordinates\n\t\tvec2 center = vec2(0.5);\n\t\tvec2 offset = uv - center;\n\t\tfloat distance = length(offset);\n\t\t\n\t\t// Apply rotation to the UV coordinates based on time\n\t\tfloat rotationSpeed = 2.5; // Adjust the rotation speed as desired\n\t\tfloat rotationAngle = time * -rotationSpeed;\n\t\tvec2 rotatedUV = vec2(\n\t\t\toffset.x * cos(rotationAngle) - offset.y * sin(rotationAngle),\n\t\t\toffset.x * sin(rotationAngle) + offset.y * cos(rotationAngle)\n\t\t);\n\t\t\n\t\t// Add the rotated UV coordinates back to the center to maintain the position\n\t\tvec2 finalUV = center + rotatedUV;\n\t\t\n\t\t// Calculate the angle based on the UV coordinates and time\n\t\tfloat angle = atan(finalUV.y - 0.5, finalUV.x - 0.5);\n\t\t\n\t\t// Calculate the rotation factor based on the distance from the center\n\t\tfloat rotation = mix(0.0, 1.0, distance);\n\t\t\n\t\t// Apply twisting and rotation to the angle to create a swirling effect\n\t\tfloat twist = sin(angle * 12.0 + rotation * 10.0) * 0.5;\n\t\t\n\t\t// Add randomness to the swirls\n\t\tfloat swirlRandomness = random(distance);\n\t\tfloat twistRandomness = random(distance * 0.5);\n\t\t\n\t\t// Apply randomness to the twisting effect\n\t\ttwist += swirlRandomness * twistRandomness * 0.25;\n\t\t\n\t\t// Calculate the fade value based on the distance from the center\n\t\tfloat fade = smoothstep(0.4, 0.5, distance);\n\t\t\n\t\t// Add randomness to the color\n\t\tfloat colorRandomness = random(distance * 5.5);\n\t\tfloat colorVariation = mix(-0.2, 0.2, colorRandomness);\n\t\t\n\t\t// Set the base color with blue and apply color variation\n\t\tvec4 baseColor = vec4(1.0, 1.0, 1.0, 1.0);\n\t\tvec4 color = baseColor + vec4(colorVariation);\n\t\t\n\t\t// Calculate the transparency based on line length and distance from center\n\t\tfloat lineLength = mix(0.1, 0.5, random(distance));\n\t\tfloat transparency = clamp(distance - twist + fade * 0.5, 0.0, 1.0);\n\t\t\n\t\t// Smoothly fade out the transparency towards the center\n\t\tfloat fadeOut = smoothstep(0.1, 0.55, distance);\n\t\ttransparency *= fadeOut;\n\t\t\n\t\t// Apply transparency to the lines based on line length\n\t\tif (twist > lineLength) {\n\t\t\ttransparency = 0.0;\n\t\t}\n\t\t\n\t\t// Set the final color with transparency\n\t\tcolor.a = transparency;\n\t\t\n\t\t// Check the boolean uniform and apply rainbow colors if true\n\t\tif (useRainbowColors) {\n\t\t\t// Calculate the hue based on the angle\n\t\t\tfloat hue = (angle + time * 10.0) / (2.0 * 3.14159);\n\t\t\thue = fract(hue); // Keep the hue within [0, 1]\n\t\t\t\n\t\t\t// Convert the hue to RGB using the HSL to RGB conversion formula\n\t\t\tvec3 rgb = clamp(abs(mod(hue * 6.0 + vec3(0.0, 4.0, 2.0), 6.0) - 3.0) - 1.0, 0.0, 1.0);\n\t\t\t\n\t\t\t// Assign the rainbow color based on the hue\n\t\t\tcolor.rgb = rgb;\n\t\t}\n\t\t\n\t\tgl_FragColor = color;\n    }\n\t",transparent:!0}),c=new THREE.Mesh(o,r);a.add(c);const l=new THREE.MeshPhongMaterial({color:16777215}),d=new THREE.Mesh(s,l);let h;if(a.add(d),d.rotation.x=-Math.PI/2,a.scale.set(1.5,1.5,1.5),1===i){const n=e(t.simple,54);h=new THREE.Vector3(n.x,n.y,n.z)}else{const n=e(t.simple,t.length);h=new THREE.Vector3(n.x,n.y,n.z)}a.position.copy(h);const m=h.clone().normalize(),u=(new THREE.Quaternion).setFromUnitVectors(new THREE.Vector3(0,0,1),m);a.name="ring-"+n,a.userData={number:n,points:t},a.quaternion.copy(u);const g=Math.random()*(2*Math.PI);return a.rotation.z=g,a}(t,a,n);i.push(o)}),i}!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const n of t)if("childList"===n.type)for(const t of n.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class i{constructor(){this.camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,.1,1e3)}getCamera(){return this.camera}}const a=[{level:1,name:"Earth",description:"Earth - the planet we live on.",backgroundLight:"0xafddf0",backgroundDark:"0x070712",tracks:[{name:"Pyramid Sightseeing",level:1,points:[{simple:{x:-3.1230314016496,y:47.44618806033391,z:15.455158642129286},length:59},{simple:{x:-4.28198062595915,y:32.536771144808,z:37.718820458736445},length:52},{simple:{x:10.76656078378565,y:12.929996445849614,z:47.07408899748679},length:54},{simple:{x:18.96403020171025,y:-6.811431034632012,z:45.75931453277371},length:57},{simple:{x:16.217259524120465,y:-29.211181565560032,z:37.187470168554256},length:53},{simple:{x:.9671581565807124,y:-42.678287168170435,z:26.02872203540411},length:59},{simple:{x:-23.908787142704625,y:-31.116914804176147,z:30.975652146820295},length:52},{simple:{x:-29.551025997812246,y:-39.90245181504456,z:5.870813457825555},length:59},{simple:{x:-46.42763052654823,y:.6561845496155503,z:-20.24187340488808},length:55}],achievements:{name:"Pyramid Sightseeing",levels:{platinum:35,gold:40,silver:45,bronze:50}}},{name:"Canal crusing",level:2,points:[{simple:{x:10.727072335090206,y:47.41103892847462,z:11.698241272209518},length:56.71421745944286},{simple:{x:18.33324404927461,y:46.50401172917501,z:-1.009010620971729},length:54.96745356042868},{simple:{x:15.17317663467264,y:37.290779788169324,z:-29.647768467409445},length:54.7591466716123},{simple:{x:9.323099163925004,y:19.865405544284158,z:-44.919439152303845},length:52.44303580101542},{simple:{x:-3.069483927435459,y:5.525199639972724,z:-49.587271953478904},length:56.38755307348459},{simple:{x:-18.186341760770954,y:-5.520590393340896,z:-46.234314819123654},length:53.08461916817752},{simple:{x:-10.133980305392738,y:-27.263477710192987,z:-40.66097785231733},length:56.015719586335294}],achievements:{name:"Canal crusing",levels:{platinum:20,gold:30,silver:40,bronze:45}}},{name:"Earth 3",level:3,points:[{simple:{x:-6.030321936987191,y:53.11037808908864,z:7.676129009490675},length:53},{simple:{x:52.32451569816361,y:12.050199943395599,z:-5.739140900589465},length:59},{simple:{x:20.448563321324958,y:36.03240482148047,z:-34.63411700729087},length:55},{simple:{x:-48.21608053394141,y:22.914837830399378,z:8.131407329052816},length:57}],achievements:{name:"Earth 3",levels:{platinum:20,gold:30,silver:40,bronze:45}}}]},{level:2,name:"Mars",description:"Mars - the red planet.",backgroundLight:"0x1a0706",backgroundDark:"0x7d0200",tracks:[{name:"The footsteps of Curiosity",level:1,points:[{simple:{x:-47.308150378809636,y:-17.896779278977757,z:18.91148326217397},length:53},{simple:{x:-53.50706262638577,y:6.869548069904277,z:2.4090575774161858},length:56},{simple:{x:19.786975158249124,y:23.26795323470244,z:-44.53176356663333},length:58},{simple:{x:-4.085838588182595,y:29.989403506299066,z:44.720706617490904},length:59}],achievements:{name:"The footsteps of Curiosity",levels:{platinum:20,gold:30,silver:40,bronze:45}}}]},{level:3,name:"Test",description:"Test-planet! For all the weird testing <3",backgroundLight:"0x3cfa02",backgroundDark:"0xe502fa",tracks:[{name:"Test",level:1,points:[{simple:{x:-47.308150378809636,y:-17.896779278977757,z:18.91148326217397},length:53},{simple:{x:-53.50706262638577,y:6.869548069904277,z:2.4090575774161858},length:56},{simple:{x:19.786975158249124,y:23.26795323470244,z:-44.53176356663333},length:58},{simple:{x:-4.085838588182595,y:29.989403506299066,z:44.720706617490904},length:59}],achievements:{name:"Test",levels:{platinum:20,gold:30,silver:40,bronze:45}}}]}];class o{static currentState;static previousState;static difficulty;static difficulties;static planet;static planets;static track;static planetTrack;static currentAchievementTracking;static currentRing;static nextRing;static raceStartTime;static raceTrackTime;static ringTime;static sinceLastRing;static mode;constructor(){if(o.instance)return o.instance;this.planets=a,this.currentState="menu",this.previousState="menu",this.ringTime={},this.planetTrack=this.planets[0].tracks[0],this.currentAchievementTracking=this.planetTrack.achievements,this.raceTrackTime=0,this.sinceLastRing=0,this.difficulty=1,this.difficulties=[{level:1,name:"Beginner",description:"Beginner flying - only left/right. No up/down, and the rings turn to you."},{level:2,name:"Intermediate",description:"Intermediate flying - both left/right and up/down."},{level:3,name:"Expert",description:"Expert flying - both left/right and up/down, and the rings are static."}],this.gameModes=[{name:"Keyboard",level:"key"},{name:"Mouse",level:"mouse"},{name:"Phone",level:"orientation"}],this.mode="key",this.planet=1,this.countdown={value:2},o.instance=this}setCurrentRing(t){this.currentRing=t}getCurrentRing(){return this.currentRing}getControls(){return this.gameModes.find(t=>t.level===this.mode).name}setCurrentPlanetTrack(t){this.planetTrack=this.planets[this.planet-1].tracks[t-1]}setNextControl(){let t=!1;this.gameModes.forEach((e,n)=>{e.level!==this.mode||t||(n===this.gameModes.length-1?this.mode=this.gameModes[0].level:this.mode=this.gameModes[n+1].level,t=!0)}),document.getElementById("controls").innerHTML=this.getControls()}resetGameStates(){"mobile"===this.device&&(document.getElementById("gui").style.display="none"),this.sinceLastRing=0,this.ringTime={},this.raceTrackTime=0,this.track.forEach((t,e)=>{0===e&&t.name.includes("ring")&&0===t.userData.number&&(this.setCurrentRing(t),this.nextRing=this.track[this.currentRing.userData.number+1]),t.children[0].material.uniforms.useRainbowColors.value=0===e})}setMode(t){this.mode=t}checkCurrentRing(t,e){this.currentRing.position.distanceTo(t)<1.1&&(e.fireSparks(t),this.currentRing.userData.number===this.track.length-1?(this.ringTime[this.currentRing.userData.number+1]=Date.now()-this.raceStartTime,window.dispatchEvent(new Event("gameCompleted")),this.setGameState("scoreboard"),this.setGameCompletionData()):(this.nextRing=this.track[this.currentRing.userData.number+1],this.currentRing.children[0].material.uniforms.useRainbowColors.value=!1,this.setCurrentRing(this.nextRing),this.currentRing.children[0].material.uniforms.useRainbowColors.value=!0,this.ringTime[this.currentRing.userData.number]=Date.now()-this.raceStartTime,this.sinceLastRing=this.ringTime[this.currentRing.userData.number]))}setGameState(t){this.currentState=t}setDifficulty(t){this.difficulty=t,window.dispatchEvent(new Event("difficultyChanged"))}setPlanet(t){this.planet=t,window.dispatchEvent(new Event("planetChanged")),this.setTrack(1)}setTrack(t){this.planetTrack=this.planets[this.planet-1].tracks[t-1],window.dispatchEvent(new Event("trackChanged")),this.currentAchievementTracking=this.planetTrack.achievements}resetGui(){document.getElementById("height").value=0,document.getElementById("gui").style.display="none"}setGameCompletionData(){document.getElementById("ringCounter").innerText=this.track.length+"/"+this.track.length;let t=this.getMedal(this.raceTrackTime,this.currentAchievementTracking);this.setMedalType(t),document.getElementById("gui").style.display="none",this.hideExitButton(),document.getElementById("allRingTimes").innerText="",document.getElementById("scoredata").innerText="";const e=document.createElement("div");e.id="scoredataHeader";const n=document.createElement("div");e.innerHTML=`\n\t\t<h2>Congratulations!</h2>\n\t\t<p>You completed the ${this.currentAchievementTracking.name} track on ${this.difficulties[this.difficulty-1].name}!</p>\n\t\t<div class="score">Track completed in <span class="highlight mainScore">${this.raceTrackTime}</span> seconds.</div>\n\t\t<div class="score">This earned you a <span class="highlight text ${t}">${t}</span> medal.</div>\n\t\t`,Object.keys(this.ringTime).forEach((t,e)=>{n.innerHTML+=`\n\t\t\t<div class="ring">Ring ${e+1} after <span class="highlight">${(this.ringTime[e+1]/1e3).toFixed(2)}</span> seconds.</div>\n\t\t\t`}),document.getElementById("scoredata").append(e),document.getElementById("allRingTimes").append(n),gsap.set(document.getElementById("scoreboard"),{zIndex:3,display:"flex"}),gsap.to(document.getElementById("scoreboard"),{opacity:1,duration:.5})}getMedal(t,e){let n="bronze";return t<=e.levels.platinum?n="platinum":t<=e.levels.gold?n="gold":t<=e.levels.silver&&(n="silver"),n}resetRacetime(){document.getElementById("racetime").innerText="",this.raceTrackTime=0}resetRingCounter(){document.getElementById("ringCounter").innerText=""}hideScoreboard(){gsap.to(document.getElementById("scoreboard"),{opacity:0,duration:.5,onComplete:()=>{gsap.set(document.getElementById("scoreboard"),{zIndex:-1,display:"none"})}}),this.resetGameStates()}positionMenuAndScene(t){t?("mobile"===this.device&&(document.getElementById("gui").style.display="none"),gsap.to(document.getElementById("menu"),{opacity:1,duration:.5,pointerEvents:"all"})):gsap.to(document.getElementById("menu"),{opacity:0,duration:.5,pointerEvents:"none"})}revealExitButton(){gsap.set(document.getElementById("exit-button"),{zIndex:10,display:"block"}),gsap.to(document.getElementById("exit-button"),{opacity:1,duration:.5})}hideExitButton(){gsap.to(document.getElementById("exit-button"),{opacity:0,duration:.5,onComplete:()=>{gsap.set(document.getElementById("exit-button"),{zIndex:-1,display:"none"})}})}setMedalType(t){document.getElementById("medal").classList.remove("bronze","silver","gold","platinum"),document.getElementById("medal").classList.add(t),document.getElementById("medal-quality").innerText=t.toUpperCase(),document.getElementById("medal-shade").innerText=t.toUpperCase()}beginCountdown(){this.setGameState("countdown"),gsap.to(document.getElementById("countdown"),{opacity:1,duration:.2}),gsap.to(this.countdown,{value:0,ease:"none",duration:this.countdown.value,onUpdate:()=>{this.countdown.value>=.1?document.getElementById("countdown").innerHTML=Math.ceil(this.countdown.value):document.getElementById("countdown").innerHTML="GO!"},onComplete:()=>{this.setGameState("playing"),"mobile"!==this.device&&"orientation"!==this.mode||(document.getElementById("gui").style.display="flex"),this.revealExitButton(),this.raceStartTime=Date.now(),this.sinceLastRing=0,this.countdown.value=2,gsap.to(document.getElementById("countdown"),{opacity:0,duration:1})}})}}class s{static movingForward;static movingBackward;static movingLeft;static movingRight;static movingUp;static movingDown;static dragonPosition;static dragonDirection;static speed;static initSpeed;static altitude;static dragon;static objectUp;static counter;static tiltFactor;static altitudeChange;static gameState;static camera;static dragon;static cameraInitialPosition;static boost;static gyroscopeAllowed;static mousePosition;static orientation;static dragonInitialDirection;static dragonInitialPosition;static dragonInitialQuaternion;static dragonInitialRotation;static initialAltitude;static tiltAcceleration;static tiltDeacceleration;static worldRadius;static dragonManager;constructor(t,e,n,i){if(this.gameState=new o,document.addEventListener("keydown",this.onKeyDown,!1),document.addEventListener("keyup",this.onKeyUp,!1),document.addEventListener("mousemove",this.onMouseMove,!1),document.getElementById("height").addEventListener("input",()=>{document.getElementById("height").value>.006?(this.movingUp=!1,this.movingDown=!0):document.getElementById("height").value<-.006?(this.movingDown=!1,this.movingUp=!0):(this.movingDown=!1,this.movingUp=!1)}),window.addEventListener("deviceorientation",this.onOrientation,!1),window.addEventListener("dragonLoaded",()=>{this.dragon=n.getDragon(),this.dragonInitialPosition=new THREE.Vector3(0,this.initialAltitude+2,0),this.dragonIniitalQuaternion=this.dragon.quaternion.clone(),this.dragonInitialRotation=this.dragon.rotation.clone(),this.cameraInitialPosition=this.camera.position.clone(),this.dragon.position.copy(this.dragonPosition),this.setMenuPlacement()}),"Gyroscope"in window){const t=new Gyroscope({frequency:60});t.addEventListener("reading",this.onGyroscrope,!1),t.start(),this.gyroscopeAllowed=!0}else this.gyroscopeAllowed=!1;screen.orientation.addEventListener("change",t=>{t.target.type,t.target.angle}),this.dragonInitialDirection=new THREE.Vector3(0,0,1),this.dragonDirection=new THREE.Vector3(0,0,1),this.dragonPosition=new THREE.Vector3(0,t+4,0),this.altitude=t+4,this.objectUp=new THREE.Vector3(0,1,0),this.counter=0,this.speed=.1,this.initSpeed=.1,this.boost=!1,this.tiltFactor=0,this.movingForward=!1,this.movingBackward=!1,this.movingLeft=!1,this.movingRight=!1,this.movingUp=!1,this.movingDown=!1,this.altitudeChange=0,this.camera=e,this.dragon=n.getDragon(),this.dragonManager=n,this.initialAltitude=this.altitude,this.tiltAcceleration=.3,this.tiltDeacceleration=2*this.tiltAcceleration,this.worldRadius=i,this.mousePosition={x:0,y:0},this.orientation={alpha:0,beta:0,gamma:0},this.currentRotationSpeed=0,this.targetRotationSpeed=0,this.rotationAcceleration=4,this.rotationDamping=5}destructor(){document.removeEventListener("keydown",this.onKeyDown,!1),document.removeEventListener("keyup",this.onKeyUp,!1),document.removeEventListener("mousemove",this.onMouseMove,!1),window.removeEventListener("deviceorientation",this.onOrientation,!1),screen.orientation.removeEventListener("change",this.setOrientationBounds,!1)}setOrientationBounds(t){}createStartFlightAnimation(t,e){(new THREE.Vector3).addVectors(t,e).divideScalar(3);const n=new THREE.Vector3(0,0,5*-this.worldRadius);return new THREE.QuadraticBezierCurve3(t.clone(),n.clone(),e.clone())}updateSkyColor(t,e,n,i){const a=new THREE.Vector3(-120,0,-120).normalize(),o=new THREE.Vector3(120,0,120).normalize(),s=t.clone().normalize(),r=s.dot(a),c=s.dot(o),l=Math.max(0,r),d=Math.max(0,c),h=new THREE.Color(parseInt(i.backgroundDark)),m=new THREE.Color(parseInt(i.backgroundLight)),u=l-d,g=h.clone().lerp(m,(u+1)/2);e.setClearColor(g);const p=.03-.02999*(l+d)/2;if("playing"===this.gameState.currentState)n.color.copy(g),n.density=p;else if("countdown"===this.gameState.currentState){const t=.05;n.density=THREE.MathUtils.lerp(n.density,p,t),n.color.lerp(g,t)}else n.density=THREE.MathUtils.lerp(n.density,1e-4,.05)}setFlightPlacement(){const t=this.calculateCameraPositionBehindDragon(),e=this.createStartFlightAnimation(this.camera.position,t);this.gameState.setGameState("transition"),this.gameState.positionMenuAndScene(!1);const n={t:0};gsap.to(n,{t:1,duration:2.5,ease:"power1.inOut",onComplete:()=>{n.t=0,this.gameState.beginCountdown()},onUpdate:()=>{const t=e.getPointAt(n.t);this.camera.position.copy(t),this.camera.lookAt(this.dragon.position)}})}resetDragonState(){this.dragon.position.copy(new THREE.Vector3(0,this.initialAltitude,0)),this.dragon.quaternion.copy(this.dragonIniitalQuaternion),this.dragon.rotation.copy(this.dragonInitialRotation),this.dragon.up.set(0,1,0),this.dragon.up.copy(new THREE.Vector3(0,1,0)),this.dragonDirection=new THREE.Vector3(0,0,1),this.dragonPosition=new THREE.Vector3(0,this.initialAltitude,0)}setMenuPlacement(t){!0===t?gsap.to(document.getElementById("blackscreen"),{opacity:1,duration:.5,onComplete:()=>{this.resetCameraAndDragon(),this.gameState.positionMenuAndScene(!0),this.gameState.setGameState("menu"),this.gameState.resetRacetime(),this.gameState.resetRingCounter(),gsap.to(document.getElementById("blackscreen"),{opacity:0,duration:.5,delay:.2})}}):(this.resetCameraAndDragon(),this.gameState.positionMenuAndScene(!0),this.gameState.setGameState("menu"),this.gameState.resetRacetime(),this.gameState.resetRingCounter())}setArrowPosition(t,e){if(void 0!==t&&("playing"!==this.gameState.currentState&&"countdown"!==this.gameState.currentState&&!0===t.visible?t.visible=!1:"playing"!==this.gameState.currentState&&"countdown"!==this.gameState.currentState||!1!==t.visible||(t.visible=!0),"countdown"===this.gameState.currentState||"playing"===this.gameState.currentState)){const n=this.camera.getWorldDirection(new THREE.Vector3).clone().multiplyScalar(-.5),i=this.dragon.position.clone().add(n).clone().normalize().multiplyScalar(this.altitude-.7);t.position.copy(i),t.lookAt(e.position),t.rotateX(Math.PI/2)}}resetCameraAndDragon(){this.camera.position.set(0,-this.worldRadius-100,-.001),this.objectUp=new THREE.Vector3(0,1,0),this.camera.up.copy(this.objectUp),this.altitude=this.initialAltitude,this.camera.lookAt(0,0,0),this.resetDragonState()}calculateCameraPositionBehindDragon(){const t=this.dragonDirection.clone().negate().clone().multiplyScalar(2);return this.dragon.position.clone().add(t).clone().normalize().multiplyScalar(this.altitude+1)}updateRotation(t){return this.currentRotationSpeed+=(this.targetRotationSpeed-this.currentRotationSpeed)*t*this.rotationAcceleration,0===this.targetRotationSpeed&&(this.currentRotationSpeed*=Math.exp(-this.rotationDamping*t)),this.currentRotationSpeed*Math.PI*t}changeDirection(t){if("playing"!==this.gameState.currentState)return;let e=0;if("key"===this.gameState.mode)this.movingLeft&&(e+=1),this.movingRight&&(e-=1);else if("mouse"===this.gameState.mode)e=this.mousePosition.x;else if("orientation"===this.gameState.mode){let t=0;(this.orientation.beta<-5||this.orientation.beta>5)&&(t=this.orientation.gamma<0?this.orientation.beta:this.orientation.beta<0?-1*this.orientation.beta-180:180-this.orientation.beta),e=THREE.MathUtils.clamp(-.02*t,-1,1)}void 0===this.currentRotationSpeed&&(this.currentRotationSpeed=0),void 0===this.targetRotationSpeed&&(this.targetRotationSpeed=0),this.targetRotationSpeed=e,this.currentRotationSpeed+=(this.targetRotationSpeed-this.currentRotationSpeed)*t*5,this.currentRotationSpeed*=Math.exp(-3*t);const n=this.currentRotationSpeed*Math.PI*t;if(0!==n){const t=(new THREE.Quaternion).setFromAxisAngle(this.objectUp,n);this.dragonDirection.applyQuaternion(t),this.objectUp.applyQuaternion(t)}this.movingDown&&(this.altitude>this.worldRadius+1&&this.altitudeChange>-.045&&("key"===this.gameState.mode?this.altitudeChange-=this.tiltAcceleration*t:"mouse"===this.gameState.mode?this.altitudeChange+=this.tiltAcceleration*t*this.mousePosition.y:"orientation"===this.gameState.mode&&(this.altitudeChange-=this.tiltAcceleration*t)),this.altitude<=this.worldRadius+1&&this.altitudeChange<0&&(this.altitudeChange+=this.tiltDeacceleration*t)),this.movingUp&&(this.altitude<this.worldRadius+10&&this.altitudeChange<.045&&("key"===this.gameState.mode?this.altitudeChange+=this.tiltAcceleration*t:"mouse"===this.gameState.mode?this.altitudeChange+=this.tiltAcceleration*t*this.mousePosition.y:"orientation"===this.gameState.mode&&(this.altitudeChange+=this.tiltAcceleration*t)),this.altitude>=this.worldRadius+10&&this.altitudeChange>0&&(this.altitudeChange-=this.tiltDeacceleration*t)),this.movingDown||this.movingUp||(this.altitudeChange>.005?this.altitudeChange-=this.tiltAcceleration*t:this.altitudeChange<-.005&&(this.altitudeChange+=this.tiltAcceleration*t),Math.abs(this.altitudeChange)<.005&&(this.altitudeChange=0)),this.altitude+=this.altitudeChange}update(t){if(void 0===this.dragon)return;if("menu"===this.gameState.currentState)return;if("transition"===this.gameState.currentState)return;if("countdown"===this.gameState.currentState)return;if("scoreboard"===this.gameState.currentState)return;this.dragonDirection.normalize();const e=this.dragonDirection.clone().multiplyScalar(this.speed),n=this.dragonPosition.clone().add(e);n.normalize().multiplyScalar(this.altitude);const i=n.clone().sub(new THREE.Vector3(0,0,0)).normalize();this.objectUp=i;const a=n.clone().sub(this.dragonPosition).normalize();this.dragonPosition=n,this.dragon.position.copy(n),this.dragon.up.copy(i),this.dragon.lookAt(n.clone().add(a)),this.dragonDirection.copy(a);const o=this.calculateCameraPositionBehindDragon();this.camera.position.copy(o),this.camera.up.copy(i),this.camera.lookAt(this.dragonPosition)}tiltDragon(t){"playing"===this.gameState.currentState&&((this.movingLeft||this.movingRight||0!==this.tiltFactor)&&(this.dragon.rotation.z+=this.tiltFactor,this.movingLeft&&this.tiltFactor>-1&&(this.tiltFactor>0?this.tiltFactor-=5*t:this.tiltFactor-=2*t),this.movingRight&&this.tiltFactor<1&&(this.tiltFactor<0?this.tiltFactor+=5*t:this.tiltFactor+=2*t)),this.movingRight||this.movingLeft||(this.tiltFactor>0?this.tiltFactor-=3*t:this.tiltFactor<0&&(this.tiltFactor+=3*t),Math.abs(this.tiltFactor)<.02&&(this.tiltFactor=0)))}fireBoost(){!0!==this.boost&&(this.boost=!0,this.dragonManager.dragonSoarStart(.2),this.dragonManager.dragonFlyFadeOut(),gsap.to(this,{speed:.7,duration:1.5,ease:"power1.in",onComplete:()=>{gsap.to(this,{speed:this.initSpeed,duration:.7,delay:1,ease:"power1.out",onComplete:()=>{this.boost=!1,this.dragonManager.dragonFlyStart(),this.dragonManager.dragonFlyFadeIn(),this.dragonManager.dragonSoarStop()}})}}))}onKeyDown=t=>{switch(t.keyCode){case 27:"playing"===this.gameState.currentState&&(this.setMenuPlacement(!0),this.gameState.hideExitButton(),this.gameState.resetGui()),"scoreboard"===this.gameState.currentState&&(this.gameState.hideScoreboard(),this.setMenuPlacement(!1),this.gameState.resetGui());break;case 38:case 87:this.movingUp=!0;break;case 37:case 65:this.movingLeft=!0;break;case 40:case 83:this.movingDown=!0;break;case 39:case 68:this.movingRight=!0;break;case 32:this.fireBoost()}};onKeyUp=t=>{switch(t.keyCode){case 38:case 87:this.movingUp=!1;break;case 37:case 65:this.movingLeft=!1;break;case 40:case 83:this.movingDown=!1;break;case 39:case 68:this.movingRight=!1}};onGyroscrope=t=>{};onOrientation=t=>{if("playing"===this.gameState.currentState&&"orientation"===this.gameState.mode){let e=t.beta;e<0&&(e+=360);const n=20;this.orientation=t,e>n&&e<180?(this.movingLeft=!1,this.movingRight=!0):e>180&&e<360-n?(this.movingRight=!1,this.movingLeft=!0):(this.movingRight=!1,this.movingLeft=!1)}};onMouseMove=t=>{"playing"===this.gameState.currentState&&"mouse"===this.gameState.mode&&(this.mousePosition.x=t.clientX/window.innerWidth*2-1,this.mousePosition.y=-t.clientY/window.innerHeight*2+1,this.mousePosition.x>.1?(this.movingLeft=!1,this.movingRight=!0):this.mousePosition.x<-.1?(this.movingRight=!1,this.movingLeft=!0):this.mousePosition.x<.05&&this.mousePosition.x>-.05&&(this.movingRight=!1,this.movingLeft=!1),this.mousePosition.y>.1?(this.movingDown=!1,this.movingUp=!0):this.mousePosition.y<-.1?(this.movingUp=!1,this.movingDown=!0):this.mousePosition.y<.05&&this.mousePosition.y>-.05&&(this.movingUp=!1,this.movingDown=!1))}}class r{static dragon;static animations;static mixer;static flying;static soar;static currentFlying;static currentSoar;constructor(t,e,n){const i=new URL(""+new URL("dragon6-tNcvt7J9.glb",import.meta.url).href,import.meta.url).href;(new THREE.GLTFLoader).load(i,i=>{this.dragon=i.scene,this.dragon.name="dragon",this.dragon.scale.set(.1,.1,.1),this.dragon.traverse(function(t){t.isMesh&&(t.castShadow=!0)}),e.add(this.dragon),n.push(this.dragon),this.mixer=new THREE.AnimationMixer(this.dragon),this.animations=i.animations,this.flying=THREE.AnimationClip.findByName(i.animations,"Flying"),this.soar=THREE.AnimationClip.findByName(i.animations,"Soar"),this.flying&&(this.currentFlying=this.mixer.clipAction(this.flying),this.currentFlying.play(),this.currentSoar=this.mixer.clipAction(this.soar)),t.push(t=>{this.mixer.update(t)}),window.dispatchEvent(new Event("dragonLoaded"))},void 0,t=>{})}getDragon(){return this.dragon}dragonSoarStart(t){t&&this.currentSoar.setEffectiveTimeScale(1).setEffectiveWeight(1).fadeIn(t),this.currentSoar=this.mixer.clipAction(this.soar),this.currentSoar.play()}dragonSoarStop(){this.currentSoar.stop()}dragonSoarFadeOut(){this.currentSoar.setEffectiveTimeScale(1).setEffectiveWeight(1).fadeOut(.2)}dragonSoarFadeIn(){this.currentSoar.reset().setEffectiveTimeScale(1).setEffectiveWeight(1).fadeIn(.2)}dragonFlyStart(){this.currentFlying=this.mixer.clipAction(this.flying),this.currentFlying.play()}dragonFlyStop(){this.currentFlying.stop()}dragonFlyFadeOut(){this.currentFlying.setEffectiveTimeScale(1).setEffectiveWeight(1).fadeOut(.2)}dragonFlyFadeIn(){this.currentFlying.reset().setEffectiveTimeScale(1).setEffectiveWeight(1).fadeIn(.2)}}class c{static gameState;static ring;constructor(){this.gameState=new o}destructor(){}constructTrack(t,e,n,i){const a=this.buildRandomTrack(t,e);return{name:i,points:a,achievements:this.calculateTimeForRoute(a,n,i)}}calculateTimeForRoute(t,e,n){let i=0;return t.forEach((n,a)=>{if(0===a)i+=e.distanceTo(new THREE.Vector3(n.x,n.y,n.z));else{const e=new THREE.Vector3(t[a-1].x,t[a-1].y,t[a-1].z);i+=e.distanceTo(new THREE.Vector3(n.x,n.y,n.z))}}),{name:n,levels:{platinum:20,gold:30,silver:40,bronze:45}}}buildRandomTrack(t,e){const n=e,i=[];for(let a=0;a<t;a++){const t=this.generateRandomPoint(n+2,n+7*Math.random()+2),e={simple:t.simple,complex:t.complex};i.push(e)}return i}generateRandomPoint(t,e){const n=Math.random(),i=Math.random(),a=2*Math.PI*n,o=Math.acos(2*i-1),s={},r=t*Math.sin(o)*Math.cos(a),c=t*Math.sin(o)*Math.sin(a),l=t*Math.cos(o),d=e*Math.sin(o)*Math.cos(a),h=e*Math.sin(o)*Math.sin(a),m=e*Math.cos(o);return s.simple=new THREE.Vector3(r,c,l),s.complex=new THREE.Vector3(d,h,m),s}generatePointFromCoordinate(t,e,n){const i=t.clone().normalize();return{simple:i.clone().multiplyScalar(e),complex:i.clone().multiplyScalar(n)}}getRing(){return this.ring}}class l{constructor(t,e,n,i){this.scene=t,this.camera=e,this.renderer=n,this.raycaster=new THREE.Raycaster,this.mouse=new THREE.Vector2,this.edit=i,this.mouseDownPosition=new THREE.Vector2,this.mouseMoved=!1,this.edit&&(window.addEventListener("mousedown",t=>this.onMouseDown(t)),window.addEventListener("mouseup",t=>this.onMouseUp(t)),window.addEventListener("mousemove",()=>this.onMouseMove()))}onMouseDown(t){this.edit&&0===t.button&&(this.mouseDownPosition.set(t.clientX,t.clientY),this.mouseMoved=!1)}onMouseMove(){this.mouseMoved=!0}onMouseUp(t){this.edit&&0===t.button&&!this.mouseMoved&&this.shootRay(t)}shootRay(t){this.mouse.x=t.clientX/window.innerWidth*2-1,this.mouse.y=-t.clientY/window.innerHeight*2+1,this.raycaster.setFromCamera(this.mouse,this.camera);const e=this.raycaster.intersectObjects(this.scene.children);if(e.length>0&&e[0].object){const t=e[0].point,n=e[0].face.normal.clone().normalize(),i=2,a=.5,o=.3,s=new THREE.ArrowHelper(n,t,i,16711680,a,o);this.scene.add(s)}}}class d{constructor(t,e){this.scene=t,this.renderer=e,this.particles=[];const n=new THREE.SphereGeometry(.03,8,8),i=new THREE.MeshBasicMaterial({transparent:!0});for(let a=0;a<200;a++){const t=new THREE.Mesh(n,i.clone());t.name="particle-"+a,t.material.color=new THREE.Color(Math.random(),Math.random(),Math.random()),t.material.opacity=0,t.userData.velocity=new THREE.Vector3,t.userData.speed=0,this.scene.add(t),this.particles.push(t)}}fireSparks(t){this.particles.forEach(e=>{const n=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()-.5).normalize(),i=2*Math.random(),a=(new THREE.Vector3).copy(t).addScaledVector(n,i);e.position.copy(a);const o=.02+.05*Math.random();e.userData.velocity.copy(n).multiplyScalar(o),e.material.opacity=1,e.visible=!0})}}class h{static FPS;static prevTick;static camera;static scene;static renderer;static threeObjects;static cannonObjects;static world;static worldRadius;static solver;static fixedTimeStep;static maxSubSteps;static stats;static previousTime;static updateFunctions;static movement;static dragon;static primaryPlanet;static planets;static blurPlane;static gameState;static racing;static editMode;static arrowPointer;static sunViewVector;static mooonViewVector;static fog;static rayTracer;static sparks;constructor(){if(this.editMode=!1,this.FPS=60,this.prevTick=0,this.fog=new THREE.FogExp2(new THREE.Color(11525616),0),this.scene=new THREE.Scene,this.scene.fog=this.fog,this.updateFunctions=[],this.worldRadius=50,this.threeObjects=[],this.cannonObjects=[],this.previousTime=Date.now(),this.sunViewVector=new THREE.Vector3(0,0,0),this.moonViewVector=new THREE.Vector3(0,0,0),this.gameState=new o,this.camera=new i,this.racing=new c(this.worldRadius),this.dragon=new r(this.updateFunctions,this.scene,this.threeObjects),this.movement=new s(this.worldRadius,this.camera.getCamera(),this.dragon,this.worldRadius),this.sparks=new d(this.scene,this.renderer),this.planets=[],this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setClearColor(0),this.renderer.shadowMap.enabled=!0,this.rayTracer=new l(this.scene,this.camera.getCamera(),this.renderer,this.editMode),!0===this.editMode){document.getElementById("menu").style.display="none",new THREE.OrbitControls(this.camera.getCamera(),this.renderer.domElement).update();const t=document.createElement("select");t.id="planetSelector",t.style.position="absolute",t.style.top="10px",t.style.right="10px",t.style.zIndex="100",t.addEventListener("change",t=>{this.setPrimaryPlanet(Number(t.target.value))}),document.body.appendChild(t),this.gameState.planets.forEach(e=>{const n=document.createElement("option");n.value=e.level,n.text=e.name,t.appendChild(n)})}document.getElementById("engine").appendChild(this.renderer.domElement),this.createUniverse(),this.start(),this.arrowPointer=this.constructHelperArrow(),window.addEventListener("gameCompleted",()=>{this.movement.resetCameraAndDragon()}),window.addEventListener("trackChanged",()=>{this.updateRings()}),window.addEventListener("difficultyChanged",()=>{this.updateRings()}),window.addEventListener("planetChanged",()=>{this.setPrimaryPlanet(this.gameState.planet),document.getElementById("trackSelector"),trackSelector.setAttribute("items",JSON.stringify(this.gameState.planets[this.gameState.planet-1].tracks))})}updateRings(){const t=this.planets[this.gameState.planet-1];for(let n=t.children.length-1;n>=0;n--){const e=t.children[n];e.name.includes("ring")&&e.parent.remove(e)}n(this.gameState.planetTrack,this.gameState.difficulty).forEach(t=>{this.planets[this.gameState.planet-1].add(t)}),this.gameState.track=this.primaryPlanet.children.filter(t=>t.name.includes("ring")),this.gameState.currentAchivementTracking=this.primaryPlanet.userData.achievements;const e=this.primaryPlanet.children.find(t=>t.name.includes("ring")&&0===t.userData.number);this.gameState.setCurrentRing(e)}createUniverse(){this.gameState.planets.forEach((e,n)=>{let i;i=0===n?function(t,e,n,i,a,o,s){const r=new URL(""+new URL("world3-BoAj-K9O.glb",import.meta.url).href,import.meta.url).href,c=new THREE.Group;return(new THREE.GLTFLoader).load(r,t=>{const e=t.scene;e.scale.set(2.5,2.5,2.5),e.name="earth",e.traverse(function(t){t.isMesh&&(t.castShadow=!0)});const n=new THREE.MeshStandardMaterial({color:16777215,transparent:!0,opacity:.9,roughness:1,metalness:0,fog:!1,side:THREE.DoubleSide});e.children.forEach((t,e)=>{t.name.includes("cloud")&&(t.material=n)}),e.children.forEach((t,e)=>{t.name.includes("rainbow")&&(t.material.fog=!1,t.material.side=THREE.DoubleSide)}),new THREE.MeshStandardMaterial({color:35529,transparent:!1,refractionRatio:.97,opacity:1,roughness:.3,metalness:.5});const i=new THREE.SpotLight(16777215,1,1e3,Math.PI/2,1,2);i.name="sun-softlight",i.position.set(-120,0,-120),a.add(i);const r=new THREE.IcosahedronGeometry(30,2,2),l=new THREE.ShaderMaterial({side:THREE.BackSide,blending:THREE.AdditiveBlending,transparent:!1,uniforms:{c:{value:.4},p:{value:6},viewVector:{value:o},glowColor:{value:new THREE.Color(16775201)},time:{value:s},intensity:{value:1}},vertexShader:"\t\n\t\t\t\tuniform vec3 viewVector;\n\t\t\t\tuniform float c;\n\t\t\t\tuniform float p;\n\t\t\t\tuniform float time; // Use time for dynamic effects\n\t\t\t\tvarying float intensity;\n\t\t\t\tvoid main() \n\t\t\t\t{\n\t\t\t\t\tvec3 vNormal = normalize( normalMatrix * normal );\n\t\t\t\t\tvec3 vNormel = normalize( normalMatrix * viewVector );\n\n\t\t\t\t\t// Add a flare effect using sin(time), scaling large time values\n\t\t\t\t\tfloat scaledTime = mod(time, 10000.0) * 0.0001; // Normalize time\n\t\t\t\t\tfloat flare = 0.5 + 0.5 * sin(scaledTime * 6.2831); // Oscillates between 0 and 1\n\t\t\t\t\tintensity = pow(c - dot(vNormal, vNormel), p) * flare;\n\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}\n\t\t\t\t",fragmentShader:"\n\t\t\t\tuniform vec3 glowColor; // Input glow color\n\t\t\t\tvarying float intensity; // Intensity of the glow\n\t\t\t\tvoid main() \n\t\t\t\t{\n\t\t\t\t\t// Scale intensity to clamp between 0 and 1\n\t\t\t\t\tfloat scaledIntensity = clamp(intensity, 0.0, 1.0);\n\n\t\t\t\t\t// Calculate the RGB glow, modulating by the intensity\n\t\t\t\t\tvec3 glow = glowColor * scaledIntensity;\n\n\t\t\t\t\t// Set alpha to 1.0 for solid color, independent of intensity\n\t\t\t\t\tgl_FragColor = vec4(glowColor, scaledIntensity);\n\t\t\t\t}\n\t\t\t\t"}),d=new THREE.Mesh(r,l);d.name="sun-glow",d.position.set(-120,0,-120),a.add(d);const h=new THREE.IcosahedronGeometry(8,2,2),m=new THREE.IcosahedronGeometry(10,2,2),u=new THREE.MeshPhongMaterial({color:11052182,opacity:1,transparent:!0,flatShading:!0}),g=new THREE.ShaderMaterial({side:THREE.BackSide,blending:THREE.AdditiveBlending,transparent:!1,uniforms:{c:{value:.4},p:{value:6},viewVector:{value:o},glowColor:{value:new THREE.Color(6906705)},time:{value:s},intensity:{value:1}},vertexShader:"\t\n\t\t\t\tuniform vec3 viewVector;\n\t\t\t\tuniform float c;\n\t\t\t\tuniform float p;\n\t\t\t\tuniform float time; // Use time for dynamic effects\n\t\t\t\tvarying float intensity;\n\t\t\t\tvoid main() \n\t\t\t\t{\n\t\t\t\t\tvec3 vNormal = normalize( normalMatrix * normal );\n\t\t\t\t\tvec3 vNormel = normalize( normalMatrix * viewVector );\n\n\t\t\t\t\t// Add a flare effect using sin(time), scaling large time values\n\t\t\t\t\tfloat scaledTime = mod(time, 10000.0) * 0.0001; // Normalize time\n\t\t\t\t\tfloat flare = 0.5 + 0.5 * sin(scaledTime * 6.2831); // Oscillates between 0 and 1\n\t\t\t\t\tintensity = pow(c - dot(vNormal, vNormel), p) * flare;\n\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}\n\t\t\t\t",fragmentShader:"\n\t\t\t\tuniform vec3 glowColor; // Input glow color\n\t\t\t\tvarying float intensity; // Intensity of the glow\n\t\t\t\tvoid main() \n\t\t\t\t{\n\t\t\t\t\t// Scale intensity to clamp between 0 and 1\n\t\t\t\t\tfloat scaledIntensity = clamp(intensity, 0.0, 1.0);\n\n\t\t\t\t\t// Calculate the RGB glow, modulating by the intensity\n\t\t\t\t\tvec3 glow = glowColor * scaledIntensity;\n\n\t\t\t\t\t// Set alpha to 1.0 for solid color, independent of intensity\n\t\t\t\t\tgl_FragColor = vec4(glowColor, scaledIntensity);\n\t\t\t\t}\n\t\t\t\t"}),p=new THREE.Mesh(h,u),v=new THREE.Mesh(m,g);v.name="moon-glow",p.position.set(120,0,120),v.position.set(120,0,120),a.add(v);const y=new THREE.DirectionalLight(9079434,.3);y.name="moon",y.position.set(120,0,120),a.add(y);const f=new THREE.AmbientLight(16777215,.1);f.name="ambient-light",a.add(f),c.add(e)},void 0,t=>{}),c.name=n,c.userData={level:e,name:n,rings:i.points,achievements:i.achievements,worldBackDrop:8900331},c}(this.worldRadius,e.level,e.name,e.tracks,this.scene,this.camera.getCamera().position,this.prevTick):1===n?function(t,e,n,i){const a=new URL(""+new URL("mars-BgZD_ZCU.glb",import.meta.url).href,import.meta.url).href,o=new THREE.Group;return(new THREE.GLTFLoader).load(a,t=>{const e=t.scene;e.scale.set(2.5,2.5,2.5),e.name="mars",e.traverse(function(t){t.isMesh&&(t.castShadow=!0)});const n=new THREE.ShaderMaterial({side:THREE.FrontSide,blending:THREE.AdditiveBlending,transparent:!1,uniforms:{time:{value:i},resolution:{value:new THREE.Vector2(800,800)},amplitude:{value:5.5}},vertexShader:"\t\n\n\t\t\t\tuniform float time; // Use time for dynamic effects\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t\tvoid main() \n\t\t\t\t{\n\t\t\t\t\t    float displacement = sin(time * 50.0 + position.x * 2.0 + position.y * 2.0) * 0.1;\n\t\t\t\t\t\tvec3 newPosition = position + normal * displacement * 0.5; // Reduce displacement factor\n\t\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);\n\t\t\t\t}\n\t\t\t\t",fragmentShader:"\n\n\t\t\t\tuniform float time;\n\t\t\t\tuniform vec2 resolution;\n\t\t\t\tuniform float amplitude;\n\n\t\t\t\tvarying vec2 vUv;\n \n\t\t\t\tvoid main() \n\t\t\t\t{\n\t\t\t\t\tvec2 uv = 3.0 * vUv.xy;\n\n\t\t\t\t\tfor (float i = 1.0; i < 20.0; i++) {\n\t\t\t\t\t\tuv.x += 0.6 / i * sin(i * 2.5 * uv.y + (time / 10.0));\n\t\t\t\t\t\tuv.y += 0.6 / i * cos(i * 1.5 * uv.x + (time / 10.0));\n\t\t\t\t\t}\n\n\t\t\t\t\tgl_FragColor = vec4(0.05 / abs(sin(time / 1.0 - uv.y + uv.x)),\n\t\t\t\t\t\t\t\t\t\t0.1 / abs(sin(time - uv.y - uv.x)),\n\t\t\t\t\t\t\t\t\t\t0.2 / abs(sin(time - uv.y - uv.x)),\n\t\t\t\t\t\t\t\t\t\t1.0);\n\t\t\t\t    \n\t\t\t\t\tgl_FragColor = vec4(0.3, 0.5, 0.3, .3);\n\t\t\t\t}\n\t\t\t\t"});e.children[0].material=n,o.add(e)},void 0,t=>{}),o.name=e,o.userData={level:t,name:e,rings:n.points,achievements:n.achievements,worldBackDrop:8900331},o}(e.level,e.name,e.tracks,this.prevTick):function(e,n,i,a){const o=16777215*Math.random()+0,s=new THREE.SphereGeometry(e,160,160),r=new THREE.MeshPhongMaterial({color:o,shininess:100}),c=new THREE.Mesh(s,r);c.position.set(0,0,0),c.receiveShadow=!0;const l=new THREE.Group;for(let d=0;d<100;d++){const n=t(e);l.add(n)}return l.add(c),l.name=i,l.userData={level:n,name:i,rings:a.points,achievements:a.achievements,worldBackDrop:Math.floor(16777215*Math.random())},l}(this.worldRadius,e.level,e.name,e.tracks),i.visible=!1,this.planets.push(i),this.addWorldObject(i)}),n(this.gameState.planetTrack,this.gameState.difficulty).forEach(t=>{this.planets[0].add(t)}),this.setPrimaryPlanet(1)}constructHelperArrow(){const t=new THREE.BoxGeometry(1,2,.5),e=new THREE.MeshPhongMaterial({color:65280}),n=new THREE.Mesh(t,e);n.position.set(this.camera.getCamera().position.x,this.camera.getCamera().position.y,this.camera.getCamera().position.z);const i=new THREE.CylinderGeometry(1,1,.5,3,1);i.translate(0,0,1),i.rotateX(-Math.PI/2);const a=new THREE.Mesh(i,e);return n.add(a),n.rotateY(-Math.PI),this.scene.add(n),n.scale.set(.1,.1,.1),n}addWorldObject(t){this.scene.add(t),this.threeObjects.push(t)}findWorldObject(t){return this.threeObjects.find(e=>e.userData.id===t)||null}rotatePlanetToInitialPosition(){gsap.to(this.primaryPlanet.rotation,{y:0,x:0,z:0,duration:1})}setDifficulty(t){this.gameState.setDifficulty(t)}setPrimaryPlanet(t){1!==t?this.scene.children.forEach(t=>{"sun-glow"===t.name&&(t.visible=!1)}):this.scene.children.forEach(t=>{"sun-glow"===t.name&&(t.visible=!0)}),this.planets.forEach(e=>{if(e.userData.level===t){void 0!==this.primaryPlanet&&(this.primaryPlanet.visible=!1),this.primaryPlanet=e,this.gameState.track=this.primaryPlanet.children.filter(t=>t.name.includes("ring")),this.gameState.currentAchivementTracking=this.primaryPlanet.userData.achievements;const t=this.primaryPlanet.children.find(t=>t.name.includes("ring")&&0===t.userData.number);this.gameState.setCurrentRing(t),this.primaryPlanet.visible=!0,this.renderer.setClearColor(e.userData.worldBackDrop)}})}setTrack(t){this.gameState.setCurrentPlanetTrack(t),n(this.gameState.planetTrack,this.gameState.difficulty)}removeWorldObject(t){this.scene.remove(t);const e=this.threeObjects.indexOf(t);-1!==e&&this.threeObjects.splice(e,1)}checkForFullScreen(){const t=document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen,e=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);!1===t&&e&&"paused"!==this.gameState.currentState&&(this.gameState.previousState=this.gameState.currentState,this.gameState.currentState="paused",document.getElementById("alert")&&document.getElementById("alert").classList.remove("hidden")),!0===t&&e&&"paused"===this.gameState.currentState&&(this.gameState.currentState=this.gameState.previousState,document.getElementById("alert")&&document.getElementById("alert").classList.add("hidden"))}updateViewVector(){const t=new THREE.Vector3(-120,0,-120),e=new THREE.Vector3(120,0,120);this.sunViewVector=(new THREE.Vector3).subVectors(this.camera.getCamera().position,t).normalize(),this.moonViewVector=(new THREE.Vector3).subVectors(this.camera.getCamera().position,e).normalize(),this.scene.children.forEach(t=>{"sun-glow"===t.name&&(t.material.uniforms.viewVector.value=this.sunViewVector),"moon-glow"===t.name&&(t.material.uniforms.viewVector.value=this.moonViewVector)})}update(){requestAnimationFrame(()=>this.update()),null!==this.camera.getCamera()&&this.updateViewVector(this.camera.getCamera()),document.hidden&&"playing"===this.gameState.currentState&&(this.movement.setMenuPlacement(!0),this.gameState.hideExitButton());let t=Math.round(this.FPS*Date.now()/1e3);if(!(t<=this.prevTick)&&(this.prevTick=t,this.checkForFullScreen(),this.stats.update(),"paused"!==this.gameState.currentState)){const t=Date.now(),e=(t-this.previousTime)/1e3;this.previousTime=t,"Mars"===this.primaryPlanet.name&&void 0!==this.primaryPlanet.children[0].children[0].material.uniforms&&(this.primaryPlanet.children[0].children[0].material.uniforms.time.value+=.1*e),this.scene.children.forEach(t=>{t.name.includes("particle")&&(t.position.add(t.userData.velocity),t.material.opacity-=.01,t.material.opacity<=0&&(t.material.opacity=0,t.visible=!1,t.userData.velocity.set(0,0,0)),t.rotation.x+=.02,t.rotation.y+=.01)}),this.primaryPlanet.children.forEach(t=>{t.name.includes("ring")&&(t.children[0].material.uniforms.time.value+=.1*e,this.dragon&&void 0!==this.dragon.getDragon()&&this.gameState.difficulty<=2&&(t.rotation.z=this.dragon.getDragon().rotation.y,t.lookAt(this.dragon.getDragon().position),t.rotateX(Math.PI/2)))}),this.dragon&&void 0!==this.dragon.getDragon()&&(this.movement.changeDirection(e),this.movement.update(e),this.movement.tiltDragon(e),this.movement.setArrowPosition(this.arrowPointer,this.gameState.currentRing),this.movement.updateSkyColor(this.dragon.getDragon().position,this.renderer,this.fog,this.gameState.planets[this.gameState.planet-1]),"playing"===this.gameState.currentState&&(this.gameState.raceTrackTime=((t-this.gameState.raceStartTime)/1e3).toFixed(2),document.getElementById("racetime").innerText=this.gameState.raceTrackTime,document.getElementById("ringCounter").innerText=Number(Number(this.gameState.currentRing.userData.number))+"/"+this.gameState.track.length,this.gameState.checkCurrentRing(this.dragon.getDragon().position,this.sparks))),"menu"!==this.gameState.currentState&&"scoreboard"!==this.gameState.currentState||void 0===this.primaryPlanet||!1!==this.editMode||(this.primaryPlanet.rotation.x+=.1*e,this.primaryPlanet.rotation.y+=.1*e,this.primaryPlanet.rotation.z+=.1*e,this.primaryPlanet.rotation.x>=2*Math.PI&&(this.primaryPlanet.rotation.x=0,this.primaryPlanet.rotation.y=0,this.primaryPlanet.rotation.z=0)),"scoreboard"===this.gameState.currentState&&(document.getElementsByClassName("mainScore")[0].innerHTML=this.gameState.raceTrackTime);for(const n of this.updateFunctions)n(e);this.renderer.render(this.scene,this.camera.getCamera())}}handleWindowResize=()=>{const t=window.innerWidth,e=window.innerHeight;this.renderer.setSize(t,e),this.camera.getCamera().aspect=t/e,this.camera.getCamera().updateProjectionMatrix()};start(){this.stats=new Stats,this.stats.showPanel(0),document.body.appendChild(this.stats.dom),this.update()}}const m=new class{static SceneManager;static socket;constructor(){this.SceneManager=new h,this.SceneManager.handleWindowResize(),window.addEventListener("resize",this.SceneManager.handleWindowResize)}};function u(){if(/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)){const t=document.querySelector("body");(t.requestFullscreen||t.webkitRequestFullScreen||t.mozRequestFullScreen||t.msRequestFullscreen).call(t),screen.orientation.lock("landscape-primary")}}!function(){document.getElementById("gui").style.display="none";const t=document.getElementById("items-container"),e=document.createElement("custom-selector");e.setAttribute("items",JSON.stringify(m.SceneManager.gameState.difficulties)),e.setAttribute("title","Difficulty"),e.setAttribute("selector","difficulty"),e.setAttribute("update",m.SceneManager.gameState.setDifficulty),document.getElementById("items-container").appendChild(e);const n=document.createElement("custom-selector");n.setAttribute("items",JSON.stringify(m.SceneManager.gameState.planets)),n.setAttribute("title","Planet"),n.setAttribute("selector","planet"),n.setAttribute("update",m.SceneManager.setPrimaryPlanet),document.getElementById("items-container").appendChild(n);const i=document.createElement("custom-selector");i.id="trackSelector",i.setAttribute("items",JSON.stringify(m.SceneManager.gameState.planets[m.SceneManager.gameState.planet-1].tracks)),i.setAttribute("title","Track"),i.setAttribute("selector","track"),i.setAttribute("update",m.SceneManager.setTrack),document.getElementById("items-container").appendChild(i);const a=document.createElement("div");a.classList.add("play-button-container");const o=document.createElement("button");o.classList.add("play-button"),o.innerHTML="PLAY",a.appendChild(o),t.appendChild(a),o.addEventListener("click",()=>{"menu"===m.SceneManager.gameState.currentState&&(m.SceneManager.gameState.resetGameStates(),u(),m.SceneManager.movement.setFlightPlacement(),m.SceneManager.rotatePlanetToInitialPosition())},!1)}(),function(){const t=document.createElement("div");t.id="scoreboard",t.innerHTML='\n\t\t<div class="scoreboard">\n\t\t\t<div id="scoredata">\n\t\t\t</div>\n\t\t\t<div class="flip-container">\n\t\t\t<div class="flip-card">\n\t\t\t\t<div class="flip-card-inner">\n\t\t\t\t<div class="flip-card-front">\n\t\t\t\t\t\x3c!-- Front content goes here --\x3e\n\t\t\t<div id="medal" class="parallax-container">\n\t\t\t\t\t<div class="parallax-layer coin-back"></div>\n\t\t\t<div class="parallax-layer coin-front"><div class="dodge"></div><div class="rough"></div><div id="medal-quality" class="quality">GOLD</div><div id="medal-shade" class="quality-shade">GOLD</div></div></div>\n\t\t\t\t\t<div class="ribbon">\n\t\t\t\t\t<div class="ribbon-default ribbon-left"></div>\n\t\t\t\t\t<div class="ribbon-default ribbon-right"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id="allRingTimes">\n\t\t\t</div>\n\t\t</div>\n\t';const e=document.createElement("div");e.classList.add("buttons");const n=document.createElement("button");n.classList.add("play-button"),n.innerText="Play Again",n.addEventListener("click",()=>{m.SceneManager.gameState.resetGameStates(),m.SceneManager.gameState.hideScoreboard(),m.SceneManager.movement.setFlightPlacement(),m.SceneManager.rotatePlanetToInitialPosition()}),e.appendChild(n);const i=document.createElement("button");i.classList.add("play-button"),i.innerText="Return to menu",i.addEventListener("click",()=>{m.SceneManager.gameState.setGameState("menu"),m.SceneManager.gameState.hideScoreboard(),m.SceneManager.gameState.positionMenuAndScene(!0)}),e.appendChild(i),t.appendChild(e),document.body.appendChild(t);const a=document.querySelector(".flip-card"),o=document.querySelector(".coin-back"),s=document.querySelector(".dodge"),r=document.querySelector(".rough");let c=0;!function(){let t=0;c=0,setInterval(()=>{t+=.01,c<20&&(c+=.5),function(t,e){a.style.transform=`rotateY(${t}deg) rotateX(${e}deg)`;const n=Math.sin(e*(Math.PI/180)),i=Math.sin(Math.PI/180*-t);o.style.transform=`translateX(${15*i}px) translateY(${15*n}px)`,s.style.backgroundPosition=Number(50+t)+"% "+Number(50+e)+"%",r.style.backgroundPosition=Number(50+t)+"% "+Number(50+e)+"%"}(Math.sin(t)*c,Math.cos(t)*c)},10)}()}(),function(){const t=document.getElementById("controls");t.innerHTML=m.SceneManager.gameState.getControls(),t.addEventListener("click",()=>{m.SceneManager.gameState.setNextControl()})}(),function(){const t=document.createElement("button");t.id="exit-button",t.innerHTML="",t.addEventListener("click",()=>{m.SceneManager.gameState.setGameState("menu"),m.SceneManager.movement.setMenuPlacement(!0),m.SceneManager.gameState.hideExitButton(),m.SceneManager.gameState.resetGui()}),document.body.appendChild(t)}(),function(){const t=document.createElement("div");t.id="alert",t.classList.add("hidden"),t.innerHTML='<span>This game needs to run fullscreen.<br>Please click the button below to enter fullscreen mode.</span><button class="play-button" id="fullscreen-button">Fullscreen</button>',document.body.appendChild(t),document.getElementById("fullscreen-button").addEventListener("click",()=>{u(),m.SceneManager.gameState.setGameState(m.SceneManager.gameState.previousState),document.getElementById("alert").classList.add("hidden")})}(),function(){const t=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);m.SceneManager.gameState.device=t?"mobile":"desktop"}(),document.getElementById("boost").addEventListener("click",()=>{m.SceneManager.movement.fireBoost()});class g extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML='\n  <style>\n    .carousel-container {\n      display: flex;\n      align-items: self-start;\n      flex-direction: column;\n    }\n\n    .carousel-box {\n      flex: 1;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding-bottom: 5px;\n    }\n\n    .carousel-item {\n      min-width: 200px;\n\t  font-size:10px;\n    }\n\n    .carousel-buttons {\n      display: flex;\n    }\n\n    .carousel-button {\n        margin-right: 5px;\n        user-select: none;\n        cursor: pointer;\n        display: block;\n        text-align: center;\n        text-decoration: none;\n        color: #fff;\n        background-size: 300% 300%;\n        color: white;\n        color: white;\n\t    border: 1px solid #2d142c;\n        height: 25px;\n        width: 25px;\n        text-align: center;\n        background-image: linear-gradient(to right, #801336 0%, #c72c41 50%, #ee4540 100%);\n\ttransition: background-position 0.5s;\n\tfont-family: \'Montserrat\', sans-serif;\n\tbox-shadow: inset 0px 0px 10px 0px #ee4540;\n    }\n\n    .carousel-button:hover {\n        background-position: right center;\n    }\n\n    .carousel-title {\n        padding-left: 30px;\n        font-weight:bold;\n\t\tpadding-bottom:5px;\n\t\tfont-size:12px\n    }\n\n    .description {\n        padding-left: 30px;\n        margin-bottom: 15px;\n        font-style: italic;\n        opacity:0.5;\n        font-size: 12px;\n    }\n\n    .disabled {\n      opacity: 0.25;\n      pointer-events: none;\n    }\n  </style>\n\n  <div class="carousel-container">\n    <div class="carousel-title"></div>\n    <div class="carousel-box">\n      <button class="carousel-button prev-btn">&lt;</button>\n      <div class="carousel-item current-item"></div>\n      <button class="carousel-button next-btn">&gt;</button>\n    </div>\n  </div>\n  <div class="description"></div>\n',this.carouselItems=[],this.currentItemIndex=0,this.onSelectCallback=null,this.gameState=new o,this.selector=null}static get observedAttributes(){return["items","title","selector","update"]}connectedCallback(){this.updateCarousel(),this.shadowRoot.querySelector(".prev-btn").addEventListener("click",this.prevItem.bind(this)),this.shadowRoot.querySelector(".next-btn").addEventListener("click",this.nextItem.bind(this))}attributeChangedCallback(t,e,n){"items"===t?(this.carouselItems=JSON.parse(n),this.currentItemIndex=0,this.updateCarousel()):"title"===t?this.shadowRoot.querySelector(".carousel-title").textContent=n:"selector"===t&&(this.selector=n)}parseFunction(t){const e=t.slice(t.indexOf("{")+1,t.lastIndexOf("}"));return Function(e)}updateCarousel(){const t=this.carouselItems[this.currentItemIndex];this.shadowRoot.querySelector(".current-item").textContent=t.name,this.shadowRoot.querySelector(".description").textContent=t.description;const e=this.shadowRoot.querySelector(".prev-btn"),n=this.shadowRoot.querySelector(".next-btn");0===this.currentItemIndex?e.classList.add("disabled"):e.classList.remove("disabled"),this.currentItemIndex===this.carouselItems.length-1?n.classList.add("disabled"):n.classList.remove("disabled")}prevItem(){this.currentItemIndex>0&&(this.currentItemIndex--,this.updateCarousel(),this.shadowRoot.querySelector(".carousel-container").classList.add("slide-right"),setTimeout(()=>{this.shadowRoot.querySelector(".carousel-container").classList.remove("slide-right")},500),this.setItem())}nextItem(){this.currentItemIndex<this.carouselItems.length-1&&(this.currentItemIndex++,this.updateCarousel(),this.shadowRoot.querySelector(".carousel-container").classList.add("slide-left"),setTimeout(()=>{this.shadowRoot.querySelector(".carousel-container").classList.remove("slide-left")},500),this.setItem())}setItem(){const t="set"+this.selector.charAt(0).toUpperCase()+this.selector.slice(1);this.gameState[t](this.carouselItems[this.currentItemIndex].level)}}customElements.define("custom-selector",g);
